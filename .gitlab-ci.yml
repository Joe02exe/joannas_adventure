stages:
  - setup
  - build
  - test

variables:
  BUILD_DIR: build
  CMAKE_BUILD_TYPE: Release
  VCPKG_ROOT: "$CI_PROJECT_DIR/vcpkg"
  VCPKG_DEFAULT_TRIPLET: "x64-linux"
  CMAKE_TOOLCHAIN_FILE: "$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
  VCPKG_BINARY_SOURCES: "clear;files,${CI_PROJECT_DIR}/vcpkg/bincache,readwrite"
  VCPKG_CACHE_KEY: "vcpkg-cache-${CI_COMMIT_REF_SLUG}"

default:
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - |
      DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        curl \
        ca-certificates \
        pkg-config \
        zip \
        unzip \
        tar \
        libxrandr-dev \
        libxcursor-dev \
        libxi-dev \
        libudev-dev \
        libfreetype-dev \
        libflac-dev \
        libvorbis-dev \
        libgl1-mesa-dev \
        libegl1-mesa-dev \
        xvfb

# --- Setup vcpkg and dependencies ---
setup:
  stage: setup
  script:
    # Clean any leftover vcpkg folder from previous runs
    - rm -rf vcpkg
    # Initialize and update submodules (including vcpkg)
    - git submodule update --init --recursive
    # Bootstrap vcpkg
    - ./vcpkg/bootstrap-vcpkg.sh
  cache:
    key: "$VCPKG_CACHE_KEY"
    paths:
      # Only cache the useful parts, not the whole folder
      - vcpkg/installed/
      - vcpkg/downloads/
      - vcpkg/bincache/
  artifacts:
    # Keep only bootstrap result for next job, not all builds
    paths:
      - vcpkg/
    expire_in: 1 week
  only:
    - branches
    - merge_requests

# --- Build stage ---
build:
  stage: build
  script:
    - rm -rf $BUILD_DIR
    - mkdir $BUILD_DIR
    - cd $BUILD_DIR
    - ls -la $CI_PROJECT_DIR/vcpkg || true
    - cmake --preset=default ..
    - cmake --build . --parallel
  needs:
    - job: setup
      artifacts: true
  cache:
    key: "$VCPKG_CACHE_KEY"
    paths:
      - vcpkg/installed/
      - vcpkg/downloads/
      - vcpkg/bincache/
  artifacts:
    paths:
      - $BUILD_DIR
    expire_in: 1 week
  only:
    - branches
    - merge_requests

# --- Test stage ---
test:
  stage: test
  script:
    - cd $BUILD_DIR
    - xvfb-run ctest -V --output-on-failure
  needs:
    - job: build
      artifacts: true
  only:
    - branches
    - merge_requests
