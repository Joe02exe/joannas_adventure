stages:
  - setup
  - build
  - test

variables:
  BUILD_DIR: build
  CMAKE_BUILD_TYPE: Release
  VCPKG_ROOT: "$CI_PROJECT_DIR/vcpkg"
  VCPKG_DEFAULT_TRIPLET: "x64-linux"
  CMAKE_TOOLCHAIN_FILE: "$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"

default:
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        curl \
        ca-certificates \
        pkg-config \
        zip \
        unzip \
        tar \
        libxrandr-dev \
        libxcursor-dev \
        libxi-dev \
        libudev-dev \
        libfreetype-dev \
        libflac-dev \
        libvorbis-dev \
        libgl1-mesa-dev \
        libegl1-mesa-dev

# --- Setup vcpkg and dependencies ---
setup:
  stage: setup
  script:
    # Clone vcpkg if not cached
    - if [ ! -d "$VCPKG_ROOT" ]; then git clone https://github.com/microsoft/vcpkg.git "$VCPKG_ROOT"; fi
    - ./vcpkg/bootstrap-vcpkg.sh
    # Install SFML (and any other libs you need)
    - ./vcpkg/vcpkg install sfml
  cache:
    key: vcpkg-cache
    paths:
      - vcpkg/
  artifacts:
    paths:
      - vcpkg/
    expire_in: 1 week
  only:
    - branches
    - merge_requests

# --- Build stage ---
build:
  stage: build
  script:
    - rm -rf $BUILD_DIR
    - mkdir $BUILD_DIR
    - cd $BUILD_DIR
    - cmake -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE -DCMAKE_TOOLCHAIN_FILE=$CMAKE_TOOLCHAIN_FILE ..
    - cmake --build . --parallel
  needs:
    - job: setup
      artifacts: true
  cache:
    key: vcpkg-cache
    paths:
      - vcpkg/
  artifacts:
    paths:
      - $BUILD_DIR
    expire_in: 1 week
  only:
    - branches
    - merge_requests

# --- Test stage ---
test:
  stage: test
  script:
    - cd $BUILD_DIR
    - ctest --output-on-failure || echo "No tests found"
  needs:
    - job: build
      artifacts: true
  only:
    - branches
    - merge_requests
